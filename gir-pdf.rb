require "prawn"
require 'open-uri'
require 'prawn/measurement_extensions'
require 'byebug'
require 'fastimage'

info_height = 60
info_padding = 20
font_size = 30

["A3"].each do |size|
  Prawn::Document.generate("gir-#{size}.pdf") do
  # byebug
    Dir["input/**/*"].each do |path|
      next unless [".png", ".jpg", ".jpeg"].include?(File.extname(path).downcase)

      character_configuration, artist_configuration = path.split(File::SEPARATOR)[-3..-2]

      _, character_name, character_species =
        character_configuration.match(/([^(]+) *\(?([^\)]+)?\)?/).to_a

      _, artist_name, artist_network =
        artist_configuration.match(/([^()]+) *\(?([^\)]+)?\)?/).to_a

      # Convert to a better format
      system("convert", path, "/tmp/gir-input.jpg")

      image_size = FastImage.size("/tmp/gir-input.jpg")

      is_portrait = image_size[1] > image_size[0]
      start_new_page(size: size, layout: is_portrait ? :portrait : :landscape, margin: [0, 0, 0, 0])

      image_record = image "/tmp/gir-input.jpg", at: [page.trim_box[0], page.trim_box[3]], fit: [page.trim_box[2], page.trim_box[3]]

      fill_color '000000'

      transparent(0.8) do
        fill { rectangle [ page.trim_box[0], page.trim_box[3] - image_record.scaled_height + info_height], image_record.scaled_width, info_height }
      end

      fill_color 'FFFFFF'

      draw_text character_name, :at => [ page.trim_box[0] + info_padding, page.trim_box[3] - image_record.scaled_height + info_height - font_size ]
    end
  end
end

# undefined method `width' for #<PDF::Core::Page:0x00007fed8e16efd0 @document=#<Prawn::Document:0x00007fed8e16fd68 @state=#<PDF::Core::DocumentState:0x00007fed8e16fa70 @store=#<PDF::Core::ObjectStore:0x00007fed8e16f958 @objects={1=>#<PDF::Core::Reference:0x00007fed8e16f7a0 @identifier=1, @gen=0, @data={:Creator=>"Prawn", :Producer=>"Prawn"}, @stream=#<PDF::Core::Stream:0x00000000000050 @stream=nil, @filters=[]>>, 2=>#<PDF::Core::Reference:0x00007fed8e16f548 @identifier=2, @gen=0, @data={:Type=>:Catalog, :Pages=>#<PDF::Core::Reference:0x00007fed8e16f318 @identifier=3, @gen=0, @data={:Type=>:Pages, :Count=>1, :Kids=>[#<PDF::Core::Reference:0x00007fed8e16e0a8 @identifier=5, @gen=0, @data={:Type=>:Page, :Parent=>#<PDF::Core::Reference:0x00007fed8e16f318 ...>, :MediaBox=>[0, 0, 612.0, 792.0], :CropBox=>[0, 0, 612.0, 792.0], :BleedBox=>[0, 0, 612.0, 792.0], :TrimBox=>[0, 0, 612.0, 792.0], :ArtBox=>[0, 0, 612.0, 792.0], :Contents=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, :Resources=>{:ProcSet=>[:PDF, :Text, :ImageB, :ImageC, :ImageI]}}, @stream=#<PDF::Core::Stream:0x00000000000078 @stream=nil, @filters=[]>>]}, @stream=#<PDF::Core::Stream:0x0000000000008c @stream=nil, @filters=[]>>}, @stream=#<PDF::Core::Stream:0x000000000000a0 @stream=nil, @filters=[]>>, 3=>#<PDF::Core::Reference:0x00007fed8e16f318 @identifier=3, @gen=0, @data={:Type=>:Pages, :Count=>1, :Kids=>[#<PDF::Core::Reference:0x00007fed8e16e0a8 @identifier=5, @gen=0, @data={:Type=>:Page, :Parent=>#<PDF::Core::Reference:0x00007fed8e16f318 ...>, :MediaBox=>[0, 0, 612.0, 792.0], :CropBox=>[0, 0, 612.0, 792.0], :BleedBox=>[0, 0, 612.0, 792.0], :TrimBox=>[0, 0, 612.0, 792.0], :ArtBox=>[0, 0, 612.0, 792.0], :Contents=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, :Resources=>{:ProcSet=>[:PDF, :Text, :ImageB, :ImageC, :ImageI]}}, @stream=#<PDF::Core::Stream:0x00000000000078 @stream=nil, @filters=[]>>]}, @stream=#<PDF::Core::Stream:0x0000000000008c @stream=nil, @filters=[]>>, 4=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, 5=>#<PDF::Core::Reference:0x00007fed8e16e0a8 @identifier=5, @gen=0, @data={:Type=>:Page, :Parent=>#<PDF::Core::Reference:0x00007fed8e16f318 @identifier=3, @gen=0, @data={:Type=>:Pages, :Count=>1, :Kids=>[#<PDF::Core::Reference:0x00007fed8e16e0a8 ...>]}, @stream=#<PDF::Core::Stream:0x0000000000008c @stream=nil, @filters=[]>>, :MediaBox=>[0, 0, 612.0, 792.0], :CropBox=>[0, 0, 612.0, 792.0], :BleedBox=>[0, 0, 612.0, 792.0], :TrimBox=>[0, 0, 612.0, 792.0], :ArtBox=>[0, 0, 612.0, 792.0], :Contents=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, :Resources=>{:ProcSet=>[:PDF, :Text, :ImageB, :ImageC, :ImageI]}}, @stream=#<PDF::Core::Stream:0x00000000000078 @stream=nil, @filters=[]>>}, @identifiers=[1, 2, 3, 4, 5], @info=1, @root=2>, @version=1.3, @pages=[#<PDF::Core::Page:0x00007fed8e16efd0 ...>], @page=#<PDF::Core::Page:0x00007fed8e16efd0 ...>, @trailer={}, @compress=false, @encrypt=false, @encryption_key=nil, @skip_encoding=false, @before_render_callbacks=[], @on_page_create_callback=nil>, @background=nil, @background_scale=1, @font_size=12, @bounding_box=#<Prawn::Document::BoundingBox:0x00007fed8e16d860 @document=#<Prawn::Document:0x00007fed8e16fd68 ...>, @parent=nil, @x=36, @y=756.0, @width=540.0, @height=720.0, @total_left_padding=0, @total_right_padding=0, @stretched_height=nil>, @margin_box=#<Prawn::Document::BoundingBox:0x00007fed8e16d860 @document=#<Prawn::Document:0x00007fed8e16fd68 ...>, @parent=nil, @x=36, @y=756.0, @width=540.0, @height=720.0, @total_left_padding=0, @total_right_padding=0, @stretched_height=nil>, @page_number=1, @text_formatter=Prawn::Text::Formatted::Parser, @renderer=#<PDF::Core::Renderer:0x00007fed8e16ead0 @state=#<PDF::Core::DocumentState:0x00007fed8e16fa70 @store=#<PDF::Core::ObjectStore:0x00007fed8e16f958 @objects={1=>#<PDF::Core::Reference:0x00007fed8e16f7a0 @identifier=1, @gen=0, @data={:Creator=>"Prawn", :Producer=>"Prawn"}, @stream=#<PDF::Core::Stream:0x00000000000050 @stream=nil, @filters=[]>>, 2=>#<PDF::Core::Reference:0x00007fed8e16f548 @identifier=2, @gen=0, @data={:Type=>:Catalog, :Pages=>#<PDF::Core::Reference:0x00007fed8e16f318 @identifier=3, @gen=0, @data={:Type=>:Pages, :Count=>1, :Kids=>[#<PDF::Core::Reference:0x00007fed8e16e0a8 @identifier=5, @gen=0, @data={:Type=>:Page, :Parent=>#<PDF::Core::Reference:0x00007fed8e16f318 ...>, :MediaBox=>[0, 0, 612.0, 792.0], :CropBox=>[0, 0, 612.0, 792.0], :BleedBox=>[0, 0, 612.0, 792.0], :TrimBox=>[0, 0, 612.0, 792.0], :ArtBox=>[0, 0, 612.0, 792.0], :Contents=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, :Resources=>{:ProcSet=>[:PDF, :Text, :ImageB, :ImageC, :ImageI]}}, @stream=#<PDF::Core::Stream:0x00000000000078 @stream=nil, @filters=[]>>]}, @stream=#<PDF::Core::Stream:0x0000000000008c @stream=nil, @filters=[]>>}, @stream=#<PDF::Core::Stream:0x000000000000a0 @stream=nil, @filters=[]>>, 3=>#<PDF::Core::Reference:0x00007fed8e16f318 @identifier=3, @gen=0, @data={:Type=>:Pages, :Count=>1, :Kids=>[#<PDF::Core::Reference:0x00007fed8e16e0a8 @identifier=5, @gen=0, @data={:Type=>:Page, :Parent=>#<PDF::Core::Reference:0x00007fed8e16f318 ...>, :MediaBox=>[0, 0, 612.0, 792.0], :CropBox=>[0, 0, 612.0, 792.0], :BleedBox=>[0, 0, 612.0, 792.0], :TrimBox=>[0, 0, 612.0, 792.0], :ArtBox=>[0, 0, 612.0, 792.0], :Contents=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, :Resources=>{:ProcSet=>[:PDF, :Text, :ImageB, :ImageC, :ImageI]}}, @stream=#<PDF::Core::Stream:0x00000000000078 @stream=nil, @filters=[]>>]}, @stream=#<PDF::Core::Stream:0x0000000000008c @stream=nil, @filters=[]>>, 4=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, 5=>#<PDF::Core::Reference:0x00007fed8e16e0a8 @identifier=5, @gen=0, @data={:Type=>:Page, :Parent=>#<PDF::Core::Reference:0x00007fed8e16f318 @identifier=3, @gen=0, @data={:Type=>:Pages, :Count=>1, :Kids=>[#<PDF::Core::Reference:0x00007fed8e16e0a8 ...>]}, @stream=#<PDF::Core::Stream:0x0000000000008c @stream=nil, @filters=[]>>, :MediaBox=>[0, 0, 612.0, 792.0], :CropBox=>[0, 0, 612.0, 792.0], :BleedBox=>[0, 0, 612.0, 792.0], :TrimBox=>[0, 0, 612.0, 792.0], :ArtBox=>[0, 0, 612.0, 792.0], :Contents=>#<PDF::Core::Reference:0x00007fed8e16e9b8 @identifier=4, @gen=0, @data={}, @stream=#<PDF::Core::Stream:0x00000000000064 @stream="q\n", @filters=[]>>, :Resources=>{:ProcSet=>[:PDF, :Text, :ImageB, :ImageC, :ImageI]}}, @stream=#<PDF::Core::Stream:0x00000000000078 @stream=nil, @filters=[]>>}, @identifiers=[1, 2, 3, 4, 5], @info=1, @root=2>, @version=1.3, @pages=[#<PDF::Core::Page:0x00007fed8e16efd0 ...>], @page=#<PDF::Core::Page:0x00007fed8e16efd0 ...>, @trailer={}, @compress=false, @encrypt=false, @encryption_key=nil, @skip_encoding=false, @before_render_callbacks=[], @on_page_create_callback=nil>, @page_number=0>, @y=756.0>, @margins={:left=>36, :right=>36, :top=>36, :bottom=>36}, @crops={:left=>0, :bottom=>0, :right=>0, :top=>0}, @bleeds={:left=>0, :bottom=>0, :right=>0, :top=>0}, @trims={:left=>0, :bottom=>0, :right=>0, :top=>0}, @art_indents={:left=>0, :bottom=>0, :right=>0, :top=>0}, @stack=#<PDF::Core::GraphicStateStack:0x00007fed8e16edf0 @stack=[#<PDF::Core::GraphicState:0x00007fed8e16ed28 @color_space={}, @fill_color="000000", @stroke_color="000000", @dash={:dash=>nil, :space=>nil, :phase=>0}, @cap_style=:butt, @join_style=:miter, @line_width=1>]>, @size="LETTER", @layout=:portrait, @stamp_stream=nil, @stamp_dictionary=nil, @content=4, @dictionary=5>